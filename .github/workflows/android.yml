name: Qt6 Android Build (Windows)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest  # 关键修改：使用Windows环境

    env:
      QT_VERSION: "6.6.3"
      NDK_VERSION: "26.3.11579264"
      ANDROID_API_LEVEL: "34"

    steps:
      - uses: actions/checkout@v4

      # 安装NDK（Windows版）
      - name: Install Android NDK
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/android/repository/android-ndk-r26b-windows.zip" -OutFile "ndk.zip"
          Expand-Archive -Path "ndk.zip" -DestinationPath "$env:GITHUB_WORKSPACE\android-sdk\ndk"
          Rename-Item "$env:GITHUB_WORKSPACE\android-sdk\ndk\android-ndk-r26b" "$env:GITHUB_WORKSPACE\android-sdk\ndk\$env:NDK_VERSION"
          echo "ANDROID_NDK_ROOT=$env:GITHUB_WORKSPACE\android-sdk\ndk\$env:NDK_VERSION" >> $env:GITHUB_ENV

      # 验证NDK安装
      - name: Check NDK installation
        run: |
          ls "$env:ANDROID_NDK_ROOT\toolchains\llvm\prebuilt\windows-x86_64\sysroot\usr\include\aarch64-linux-android\bits"

      # 安装Qt（Windows版）
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: android
          arch: ${{ env.QT_ARCH }}
          modules: qt5compat qtcharts qtsensors

      # Windows环境构建
      - name: Build with qmake
        shell: cmd
        run: |
          set ANDROID_NDK_ROOT=%GITHUB_WORKSPACE%\android-sdk\ndk\%NDK_VERSION%
          qmake Knot.pro -spec android-clang CONFIG+=release ANDROID_ABIS=arm64-v8a
          jom.exe -j %NUMBER_OF_PROCESSORS%
          jom.exe apk INSTALL_ROOT=build

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Android-APK
          path: build\android-build\build\outputs\apk\release\android-build-release-unsigned.apk
