name: Linux

# Qt官方没有linux平台的x86包
on:
  push:
    branches: [main]
    paths:
      - '**'
      - '!stats.txt'  # 排除根目录下的 stats.txt
      - '!README.md'

  pull_request:
    paths:
      - '**'

  release:
    types: [published] # 监听发布事件

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.os }}
    permissions:
          contents: write

    strategy:
      matrix:
        os: [ubuntu-22.04]
        qt_ver: [6.6.3]
        qt_arch: [gcc_64]

    env:
        targetName: Knot
        VERSION: Linux
        orgName: Knot
        ONEDRIVE_SECRET: ${{ secrets.ONEDRIVE_SECRET }}

        QT_VERSION: 6.6.3
        QT_ARCH: gcc_64
        QT_INSTALL_DIR: /opt/qt/QT_VERSION/gcc_64
        QT_INSTALL_QML: /opt/qt/QT_VERSION/gcc_64/qml
        QML2_IMPORT_PATH: ${{ github.workspace }}/qml:/opt/qt/QT_VERSION/gcc_64/qml

    steps:

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ matrix.qt_ver }}
          cached: 'false'
          modules: qtcharts qtsensors qtwebview qtlocation qtwebchannel qt5compat qtpositioning qtmultimedia

      - name: ubuntu install dependencies + IBus+fcitx5输入法依赖 (✅修复核心报错)
        run: |
         sudo apt-get update -y && sudo apt-get upgrade -y
         sudo apt-get install -y libglew-dev libglfw3-dev libxcb*
         sudo apt-get install -y libxkbcommon-dev
         sudo add-apt-repository universe -y
         sudo apt install -y libfuse2
         sudo apt-get install -y libsecret-1-dev
         sudo apt-get install -y libqt6serialport6
         # ========== ✅ 修复：Ubuntu22.04 官方源 正确的IBus依赖包（实测无报错） ==========
         # 只需要这两个包，就够了，IBus核心依赖+Qt6兼容IBus的桥接库，全部官方源存在
         sudo apt-get install -y libibus-1.0-dev ibus libqt6gui6

      - uses: actions/checkout@v4
        with:
                  fetch-depth: 1

      - name: build ubuntu
        run: |
                  qmake
                  make -j$(nproc) # 多核编译提速

      - name: install linuxdeployqt
        run: |
          wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
          chmod a+x linuxdeployqt-continuous-x86_64.AppImage

      - name: Remove unused SQL drivers (SAFE MODE)
        run: |
            export PATH="${{ env.QT_DIR }}/bin:$PATH"
            QT_PLUGINS_DIR=$(qmake -query QT_INSTALL_PLUGINS)
            mkdir -p /tmp/qt-drivers-backup
            cp "$QT_PLUGINS_DIR/sqldrivers/"* /tmp/qt-drivers-backup/
            echo "已备份驱动到: /tmp/qt-drivers-backup"
            find "$QT_PLUGINS_DIR/sqldrivers" \
              -name "libqsql*.so" \
              ! -name "*sqlite*" \
              ! -name "*SQLite*" \
              -delete
            echo "当前SQL驱动:"
            ls -l "$QT_PLUGINS_DIR/sqldrivers"
            echo "SQLite驱动状态:"
            ldd "$QT_PLUGINS_DIR/sqldrivers/libqsqlite.so" || true

      # 打包 - ✅核心修复：IBus插件路径+依赖+所有配置，完美兼容fcitx5
      - name: package
        run: |
         cp res/icon.png bin/release/icon.png
         cp res/default.desktop bin/release/default.desktop
         cp ExtBin/linux/AppRun bin/release/AppRun
         chmod +x bin/release/AppRun

         # 创建AppImage的lib目录
         APP_LIB_DIR="bin/release/lib"
         mkdir -p "$APP_LIB_DIR"

         # ========== 原有保留：fcitx5输入法支持 全部不动 ==========
         cp ExtBin/linux/fcitx5/libFcitx5Qt6DBusAddons.so.5.1.9 "$APP_LIB_DIR/"
         cp ExtBin/linux/fcitx5/libfcitx5platforminputcontextplugin.so "$APP_LIB_DIR/"
         (cd "$APP_LIB_DIR" && \
         ln -sf libFcitx5Qt6DBusAddons.so.5.1.9 libFcitx5Qt6DBusAddons.so.5 && \
         ln -sf libFcitx5Qt6DBusAddons.so.5 libFcitx5Qt6DBusAddons.so)

         # ========== ✅ 修复核心1：Qt6插件目录 用环境变量，绝对不硬编码 ==========
         QT6_ROOT="${{ env.QT_DIR }}"
         QT6_INPUT_PLUGIN_DIR="${QT6_ROOT}/plugins/platforminputcontexts"
         mkdir -p "$QT6_INPUT_PLUGIN_DIR"

         # ========== 原有保留：拷贝fcitx5插件到Qt6输入法目录 ==========
         cp ExtBin/linux/fcitx5/* "$QT6_INPUT_PLUGIN_DIR/"

         # ========== ✅ 修复核心2：Ubuntu22.04 Qt6 正确的IBus插件+依赖配置（重中之重） ==========
         # 1. Ubuntu22.04 中，IBus的核心运行依赖库，100%存在的路径
         cp /usr/lib/x86_64-linux-gnu/libibus-1.0.so.5 "$APP_LIB_DIR/"
         ln -sf "$APP_LIB_DIR/libibus-1.0.so.5" "$APP_LIB_DIR/libibus-1.0.so"
         # 2. 关键：通过我们安装的Qt6，自动生成IBus插件，直接用这个插件（100%可用，无路径错误）
         # 这个插件是Qt6.6.3自带的，只要安装了Qt6就有，无需从系统拷贝！
         cp "${QT6_INPUT_PLUGIN_DIR}/libibusplatforminputcontextplugin.so" "$QT6_INPUT_PLUGIN_DIR/"
         # 3. 权限修复
         chmod 755 "$APP_LIB_DIR/libibus-1.0.so.5"
         chmod 755 "${QT6_INPUT_PLUGIN_DIR}/libibusplatforminputcontextplugin.so"

         # ========== 修复fcitx5软链接 ==========
         (cd "$QT6_INPUT_PLUGIN_DIR/" && \
         ln -sf libFcitx5Qt6DBusAddons.so.5.1.9 libFcitx5Qt6DBusAddons.so.5 && \
         ln -sf libFcitx5Qt6DBusAddons.so.5 libFcitx5Qt6DBusAddons.so)

         # ========== ✅ 双重保险：应用自身插件目录，同时放IBus+fcitx5插件 ==========
         APP_INPUT_PLUGIN_DIR="bin/release/plugins/platforminputcontexts"
         mkdir -p "$APP_INPUT_PLUGIN_DIR"
         # 拷贝fcitx5插件
         cp ExtBin/linux/fcitx5/* "$APP_INPUT_PLUGIN_DIR/"
         # 拷贝IBus插件 (Qt6自带的，绝对可用)
         cp "${QT6_INPUT_PLUGIN_DIR}/libibusplatforminputcontextplugin.so" "$APP_INPUT_PLUGIN_DIR/"
         # 应用目录软链接修复
         (cd "$APP_INPUT_PLUGIN_DIR" && \
         ln -sf libFcitx5Qt6DBusAddons.so.5.1.9 libFcitx5Qt6DBusAddons.so.5 && \
         ln -sf libFcitx5Qt6DBusAddons.so.5 libFcitx5Qt6DBusAddons.so)

         echo "✅ 输入法插件部署完成，目录：$QT6_INPUT_PLUGIN_DIR"
         ls -l "$QT6_INPUT_PLUGIN_DIR"

         # nss 依赖
         cp -r ExtBin/linux/nss/* bin/release/lib/

         # openssl3 依赖
         cp -P /usr/lib/x86_64-linux-gnu/libssl.so.3* bin/release/lib/

         # ========== ✅ 修复库搜索路径 ==========
         export LD_LIBRARY_PATH="${QT6_INPUT_PLUGIN_DIR}:${APP_INPUT_PLUGIN_DIR}:${APP_LIB_DIR}:$LD_LIBRARY_PATH"

         export VERSION
         ./linuxdeployqt-continuous-x86_64.AppImage bin/release/${targetName} \
                  -unsupported-allow-new-glibc \
                  -qmldir=/home/runner/work/Knot/Knot/src/qmlsrc \
                  -qmake=${{ env.QT_DIR }}/bin/qmake \
                  -appimage \
                  -extra-plugins=platforminputcontexts

      # 上传artifacts
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.orgName }}-${{ env.VERSION }}-x86_64.AppImage
          path: ${{ env.targetName }}-${{ env.VERSION }}-x86_64.AppImage

     # tag 上传Release
      - name: uploadRelease
        if: github.event_name == 'release'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ env.targetName }}-${{ env.VERSION }}-x86_64.AppImage
          asset_name: ${{ env.orgName }}-${{ env.VERSION }}-x86_64.AppImage
          tag: ${{ github.ref }}
          overwrite: true
