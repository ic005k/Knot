name: Linux

# Qt官方没有linux平台的x86包
on:
  push:
    branches: [main]
    paths:
      - '**'
      - '!stats.txt'  # 排除根目录下的 stats.txt
      - '!README.md'

  pull_request:
    paths:
      - '**'

  release:
    types: [published] # 监听发布事件

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.os }}
    # 添加权限声明
    permissions:
          contents: write

    strategy:
      matrix:
        os: [ubuntu-22.04]
        qt_ver: [6.6.3]
        qt_arch: [gcc_64]

    env:
        targetName: Knot
        VERSION: Linux
        orgName: Knot
        ONEDRIVE_SECRET: ${{ secrets.ONEDRIVE_SECRET }}

        QT_VERSION: 6.6.3
        QT_ARCH: gcc_64
        QT_INSTALL_DIR: /opt/qt/QT_VERSION/gcc_64
        QT_INSTALL_QML: /opt/qt/QT_VERSION/gcc_64/qml
        QML2_IMPORT_PATH: ${{ github.workspace }}/qml:/opt/qt/QT_VERSION/gcc_64/qml

    steps:

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ matrix.qt_ver }}
          cached: 'false'
          modules: qtcharts qtsensors qtwebview qtlocation qtwebchannel qt5compat qtpositioning qtmultimedia

      - name: ubuntu install GL library + IBus依赖(关键新增)
        run: |
         sudo apt-get update -y
         sudo apt-get install -y libglew-dev libglfw3-dev libxcb*
         sudo apt-get install libxkbcommon-dev
         sudo add-apt-repository universe -y
         sudo apt install libfuse2 -y
         sudo apt-get install libsecret-1-dev -y
         sudo apt-get install -y libqt6serialport6
         # ========== 关键新增：安装IBus输入法的所有依赖库 ==========
         sudo apt-get install -y libibus-1.0-dev libqt6ibusplatforminputcontextplugin6 qt6-ibase-platforminputcontext-plugin

      - uses: actions/checkout@v4
        with:
                  fetch-depth: 1

      - name: build ubuntu
        run: |
                  qmake
                  make -j$(nproc) # 优化：多核编译提速

      - name: install linuxdeployqt
        run: |
          wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
          chmod a+x linuxdeployqt-continuous-x86_64.AppImage

      - name: Remove unused SQL drivers (SAFE MODE)
        run: |
            export PATH="${{ env.QT_DIR }}/bin:$PATH"
            QT_PLUGINS_DIR=$(qmake -query QT_INSTALL_PLUGINS)
            mkdir -p /tmp/qt-drivers-backup
            cp "$QT_PLUGINS_DIR/sqldrivers/"* /tmp/qt-drivers-backup/
            echo "已备份驱动到: /tmp/qt-drivers-backup"
            find "$QT_PLUGINS_DIR/sqldrivers" \
              -name "libqsql*.so" \
              ! -name "*sqlite*" \
              ! -name "*SQLite*" \
              -delete
            echo "当前SQL驱动:"
            ls -l "$QT_PLUGINS_DIR/sqldrivers"
            echo "SQLite驱动状态:"
            ldd "$QT_PLUGINS_DIR/sqldrivers/libqsqlite.so" || true

      # 打包 - 核心修改区：保留fcitx5 + 新增完整IBus支持
      - name: package
        run: |
         cp res/icon.png bin/release/icon.png
         cp res/default.desktop bin/release/default.desktop
         cp ExtBin/linux/AppRun bin/release/AppRun
         chmod +x bin/release/AppRun

         # 创建AppImage的lib目录（用于存放依赖库）
         APP_LIB_DIR="bin/release/lib"
         mkdir -p "$APP_LIB_DIR"

         # ========== 原有保留：复制fcitx5依赖库到AppImage的lib目录 ==========
         cp ExtBin/linux/fcitx5/libFcitx5Qt6DBusAddons.so.5.1.9 "$APP_LIB_DIR/"
         cp ExtBin/linux/fcitx5/libfcitx5platforminputcontextplugin.so "$APP_LIB_DIR/"

         # 创建fcitx5库的符号链接
         (cd "$APP_LIB_DIR" && \
         ln -sf libFcitx5Qt6DBusAddons.so.5.1.9 libFcitx5Qt6DBusAddons.so.5 && \
         ln -sf libFcitx5Qt6DBusAddons.so.5 libFcitx5Qt6DBusAddons.so)

         # ========== 关键1：定义QT6插件根目录（修复原脚本硬编码问题，推荐写法） ==========
         QT6_ROOT="${{ env.QT_DIR }}"
         QT6_PLUGINS_DIR="${QT6_ROOT}/plugins/platforminputcontexts"
         mkdir -p "$QT6_PLUGINS_DIR"
         echo "Qt6输入法插件目录: $QT6_PLUGINS_DIR"

         # ========== 原有保留：拷贝fcitx5插件到Qt6输入法插件目录 ==========
         cp ExtBin/linux/fcitx5/* "$QT6_PLUGINS_DIR/"

         # ========== 关键2：新增IBUS输入法核心插件拷贝（完整支持IBus） ==========
         # 从系统安装的Qt6目录拷贝官方IBus插件，这是IBus输入的核心文件，缺一不可
         cp /usr/lib/x86_64-linux-gnu/qt6/plugins/platforminputcontexts/libibusplatforminputcontextplugin.so "$QT6_PLUGINS_DIR/"
         # 拷贝IBus依赖库，防止打包后缺失依赖
         cp /usr/lib/x86_64-linux-gnu/libibus-1.0.so.5 "$APP_LIB_DIR/"
         ln -sf "$APP_LIB_DIR/libibus-1.0.so.5" "$APP_LIB_DIR/libibus-1.0.so"

         # ========== 修复原脚本fcitx5的符号链接（目录修正） ==========
         (cd "$QT6_PLUGINS_DIR/" && \
         ln -sf libFcitx5Qt6DBusAddons.so.5.1.9 libFcitx5Qt6DBusAddons.so.5 && \
         ln -sf libFcitx5Qt6DBusAddons.so.5 libFcitx5Qt6DBusAddons.so)

         # ========== 关键3：新增IBUS插件的权限配置 ==========
         chmod -R 755 "$QT6_PLUGINS_DIR"
         chmod 755 "$APP_LIB_DIR/libibus-1.0.so.5"

         # ========== 关键4：创建应用自身的插件目录，双输入法插件都拷贝（双重保险） ==========
         APP_PLUGINS_DIR="bin/release/plugins/platforminputcontexts"
         mkdir -p "$APP_PLUGINS_DIR"
         # 拷贝fcitx5插件
         cp ExtBin/linux/fcitx5/* "$APP_PLUGINS_DIR/"
         # 拷贝ibus插件
         cp /usr/lib/x86_64-linux-gnu/qt6/plugins/platforminputcontexts/libibusplatforminputcontextplugin.so "$APP_PLUGINS_DIR/"
         # 应用插件目录的符号链接
         (cd "$APP_PLUGINS_DIR" && \
         ln -sf libFcitx5Qt6DBusAddons.so.5.1.9 libFcitx5Qt6DBusAddons.so.5 && \
         ln -sf libFcitx5Qt6DBusAddons.so.5 libFcitx5Qt6DBusAddons.so)

         echo "Copied all input plugins to: $QT6_PLUGINS_DIR and $APP_PLUGINS_DIR"
         ls -l "$QT6_PLUGINS_DIR"

         # nss
         cp -r ExtBin/linux/nss/* bin/release/lib/

         # openssl3
         cp -P /usr/lib/x86_64-linux-gnu/libssl.so.3* bin/release/lib/

         # 运行 linuxdeployqt 前，添加完整的库搜索路径
         export LD_LIBRARY_PATH="${QT6_PLUGINS_DIR}:${APP_PLUGINS_DIR}:${APP_LIB_DIR}:$LD_LIBRARY_PATH"

         export VERSION
         ./linuxdeployqt-continuous-x86_64.AppImage bin/release/${targetName} \
                  -unsupported-allow-new-glibc \
                  -qmldir=/home/runner/work/Knot/Knot/src/qmlsrc \
                  -qmake=${{ env.QT_DIR }}/bin/qmake \
                  -appimage \
                  -extra-plugins=platforminputcontexts # 强制打包输入法插件，关键参数

      # 上传artifacts
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.orgName }}-${{ env.VERSION }}-x86_64.AppImage
          path: ${{ env.targetName }}-${{ env.VERSION }}-x86_64.AppImage

     # tag 上传Release
      - name: uploadRelease
        if: github.event_name == 'release'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ env.targetName }}-${{ env.VERSION }}-x86_64.AppImage
          asset_name: ${{ env.orgName }}-${{ env.VERSION }}-x86_64.AppImage
          tag: ${{ github.ref }}
          overwrite: true
